---
- name: Install upstream deb
  ansible.builtin.apt:
    deb: "{{ rclone_package }}"
    state: present
  tags:
    - rclone

- name: Create config dir
  ansible.builtin.file:
    path: /root/.config/rclone
    owner: root
    group: root
    mode: o=rwx,g=rx,o=rx
    state: directory
  tags:
    - rclone

- name: Write config file
  ansible.builtin.template:
    src: config.j2
    dest: /root/.config/rclone/rclone.conf
    owner: root
    group: root
    mode: u=rw,g=rw,o=
  tags:
    - rclone

- name: Backup from url
  loop: "{{ rclone_backups_general + rclone_backups_extra }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - false if item.url is not defined else (item.url | length > 0)
    - true if item.state is not defined else item.state == "present"
  ansible.builtin.get_url:
    url: "{{ item.url }}"
    dest: "{{ item.path | default('/usr/bin') }}/{{ item.name }}"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=
  tags:
    - rclone

- name: Backup from file
  loop: "{{ rclone_backups_general + rclone_backups_extra }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - false if item.src is not defined else (item.src | length > 0)
    - true if item.state is not defined else item.state == "present"
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.path | default('/usr/bin') }}/{{ item.name }}"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=
  tags:
    - rclone

- name: Backup from content
  loop: "{{ rclone_backups_general + rclone_backups_extra }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - false if item.content is not defined else (item.content | length > 0)
    - true if item.state is not defined else item.state == "present"
  ansible.builtin.template:
    src: script.j2
    dest: "{{ item.path | default('/usr/bin') }}/{{ item.name }}"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=
  tags:
    - rclone

- name: Delete backup script
  loop: "{{ rclone_backups_general + rclone_backups_extra }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - false if item.state is not defined else item.state == "absent"
  ansible.builtin.file:
    path: "{{ item.path | default('/usr/bin') }}/{{ item.name }}"
    state: absent
  tags:
    - rclone

- name: Create backup cronjob
  loop: "{{ rclone_backups_general + rclone_backups_extra }}"
  loop_control:
    label: "{{ item.name }}"
  ansible.builtin.cron:
    name: "rclone {{ item.name }}"
    minute: "{{ item.minute | default(omit) }}"
    hour: "{{ item.hour | default(omit) }}"
    day: "{{ item.day | default(omit) }}"
    month: "{{ item.month | default(omit) }}"
    weekday: "{{ item.weekday | default(omit) }}"
    job: "cronic {{ '/usr/bin' if item.path is not defined else item.path }}/{{ item.name }}"
    state: "{{ 'present' if item.state is not defined else item.state }}"
  tags:
    - rclone

...
